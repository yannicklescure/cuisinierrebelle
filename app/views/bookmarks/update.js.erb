root = document.querySelector("#root");

bookmark = `<i class="material-icons md-18 align-icons">bookmark_border</i>`;
bookmarkFill = `<i class="material-icons md-18 align-icons">bookmark</i>`;

if (root) {
  bookmarksCount = parseInt(root.dataset.bookmarksCount);
  // bookmarksCount = document.querySelector(`[data-bookmarks-count="${bookmarksCount}"`);
  card = document.querySelector("[data-recipe='<%= @recipe.id %>']");
  bookmarked = document.querySelector("[data-bookmark-recipe='<%= @recipe.id %>']");
  faBookmark = document.querySelector(".fa-bookmark-<%= @recipe.id %>");

  returnPosition = () => {
    let data = window.location.href.match(/https?:\/(?<domain>\/\w+.+:\d+|\/\w+.\w+.\w+)(?<lang>\/en|\/es|\/fr)?(?<controller>\/\w+)?(?<page>\/.+)?/);
    // console.log(data.groups.domain);
    let currentLang = data.groups.lang || null;
    if(currentLang != null) currentLang = currentLang.replace('/','');
    let currentController = data.groups.controller || null;
    if(currentController != null) currentController = currentController.replace('/','');
    let currentPage = data.groups.page || null;
    if(currentPage != null) currentPage = currentPage.replace('/','');
    return {
      currentLang: currentLang,
      currentController: currentController,
      currentPage: currentPage
    }
  }

  fade = (element) => {
    var op = 1;  // initial opacity
    var timer = setInterval(function () {
        if (op <= 0.1){
          clearInterval(timer);
          element.style.display = 'none';
        }
        element.style.opacity = op;
        element.style.filter = 'alpha(opacity=' + op * 100 + ")";
        op -= op * 0.1;
    }, 50);
    return true;
  }

  unfade = (element) => {
    var op = 0.1;  // initial opacity
    element.style.display = 'block';
    var timer = setInterval(function () {
        if (op >= 1){
            clearInterval(timer);
        }
        element.style.opacity = op;
        element.style.filter = 'alpha(opacity=' + op * 100 + ")";
        op += op * 0.1;
    }, 10);
    return true;
  }

  data = JSON.parse(localStorage.getItem('recipes'))
  if(<%= @bookmarked %>) {
    data.user.bookmarks.recipes.unshift({
      recipe: {
        id: <%= @recipe.id %>,
        slug: "<%= @recipe.slug %>",
        title: "<%= @recipe.title %>",
        subtitle: "<%= @recipe.subtitle %>",
        video: "<%= @recipe.video %>",
        direction: "<%= @recipe.direction.dump %>",
        description: "<%= @recipe.description.dump %>",
        likes_count: "<%= @recipe.likes_count %>",
        photo: {
          card: { url: "<%= @recipe.photo.url(:card) %>" },
          full: { url: "<%= @recipe.photo.url(:full) %>" },
          preview: { url: "<%= @recipe.photo.url(:preview) %>" },
          thumb: { url: "<%= @recipe.photo.url(:thumb) %>" },
        },
      },
      user: {
        slug: "<%= @recipe.user.slug %>",
        name: "<%= @recipe.user.name %>",
        image: {
          full: { url: "<%= @recipe.user.image.url(:full) %>" },
          preview: { url: "<%= @recipe.user.image.url(:preview) %>" },
          thumb: { url: "<%= @recipe.user.image.url(:thumb) %>" },
        },
        checked: "<%= @recipe.user.checked %>"
      },
    });

    bookmarksCount += 1;
    root.dataset.bookmarksCount = bookmarksCount;
    bookmarked.innerHTML = bookmarkFill;
    if(faBookmark != null) {
      faBookmark.classList.remove('d-none');
      unfade(faBookmark);
      setTimeout(() => {
        fade(faBookmark);
        setTimeout(() => {faBookmark.classList.add('d-none')}, 500);
      }, 500);
    }
  } else {
    el = data.user.bookmarks.recipes.filter(item => item.recipe.id === <%= @recipe.id %>)[0]
    console.log(el)
    position = data.user.bookmarks.recipes.indexOf(el)
    data.user.bookmarks.recipes.splice(position,1)

    bookmarksCount -= 1;
    root.dataset.bookmarksCount = bookmarksCount;
    bookmarked.innerHTML = bookmark;
    // if(returnPosition().currentPage && returnPosition().currentPage.match(/\/bookmarks/)) {
    //   card.parentElement.remove();
    //   if(bookmarksCount === 0) root.innerHTML = `<p class="mx-auto mt-5"><%= t('.no_bookmarks_html') %></p>`;
    // }
  }
  localStorage.setItem('recipes', JSON.stringify(data));
} else {
  bookmarked = document.querySelector("[data-bookmark-recipe='<%= @recipe.id %>']");
  if(<%= @bookmarked %>) {
    bookmarked.innerHTML = bookmarkFill;
  } else {
    bookmarked.innerHTML = bookmark;
  }
}
